FROM node:20.11 AS builder

RUN apt update \
    && apt install -y openjdk-17-jre \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /builder/vulnerabilitytracer-dashboard
COPY vulnerabilitytracer-dashboard/package.json vulnerabilitytracer-dashboard/package-lock.json ./

RUN --mount=type=cache,target=/root/.npm/_cacache npm install
RUN npx openapi-generator-cli version

WORKDIR /builder/api
COPY api/vulnerabilitytracer-manager.yaml ./

WORKDIR /builder/vulnerabilitytracer-dashboard
COPY vulnerabilitytracer-dashboard/ .
RUN --mount=type=cache,target=/builder/.angular/cache \
    npm run build

FROM nginx:1.21-alpine AS final

COPY --from=builder /builder/vulnerabilitytracer-dashboard/dist/vulnerabilitytracer-dashboard/browser /srv/
COPY vulnerabilitytracer-dashboard/docker/nginx.conf /etc/nginx/conf.d/default.conf
