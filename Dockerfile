FROM openjdk:11.0.16-jdk-bullseye AS basebuilder

ENV GRADLE_USER_HOME "/gradle-home"

WORKDIR /builder

COPY settings.gradle.kts gradlew ./
COPY gradle gradle
COPY vulnerabilitytracer-gradle-plugin vulnerabilitytracer-gradle-plugin

FROM basebuilder AS microservicebuilder

COPY microservice microservice

RUN --mount=type=cache,target=/gradle-home \
    ./gradlew assemble --no-daemon \
    && java -Djarmode=layertools -jar microservice/build/libs/microservice.jar extract

FROM basebuilder AS javaagentbuilder

COPY vulnerabilitytracer-javaagent vulnerabilitytracer-javaagent

RUN --mount=type=cache,target=/gradle-home \
    ./gradlew extendedAgentJar --no-daemon

FROM ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java:1.23.0 AS javaagentfinal

COPY --from=javaagentbuilder /builder/vulnerabilitytracer-javaagent/build/libs/vulnerabilitytracer-javaagent.jar /javaagent.jar

FROM openjdk:11.0.16-slim AS microservicefinal
EXPOSE 8000

WORKDIR /app

COPY --from=microservicebuilder /builder/dependencies ./
COPY --from=microservicebuilder /builder/spring-boot-loader ./
COPY --from=microservicebuilder /builder/snapshot-dependencies ./
COPY --from=microservicebuilder /builder/microservice/vulnerabilitytracer-report.json ./
COPY --from=microservicebuilder /builder/application ./

CMD ["java", "org.springframework.boot.loader.JarLauncher"]