FROM openjdk:11.0.16-jdk-bullseye AS javabasebuilder

ENV GRADLE_USER_HOME "/gradle-home"

WORKDIR /builder/api
COPY api/ ./

WORKDIR /builder
COPY vulnerabilitytracer-java vulnerabilitytracer-java

FROM javabasebuilder AS microservicebuilder

COPY microservices microservices

WORKDIR /builder/microservices
RUN --mount=type=cache,target=/gradle-home \
    ./gradlew vulnerabilityTracerGenerateReport assemble --no-daemon --stacktrace

WORKDIR /builder/microservices/downstream-caller-service
RUN java -Djarmode=layertools -jar build/libs/downstream-caller-service.jar extract

WORKDIR /builder/microservices/generator-service
RUN java -Djarmode=layertools -jar build/libs/generator-service.jar extract

FROM javabasebuilder AS javaagentbuilder

WORKDIR /builder/vulnerabilitytracer-java
RUN --mount=type=cache,target=/gradle-home \
    ./gradlew extendedAgentJar --no-daemon

FROM ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java:1.23.0 AS javaagentfinal

COPY --from=javaagentbuilder /builder/vulnerabilitytracer-java/vulnerabilitytracer-javaagent/build/libs/vulnerabilitytracer-javaagent.jar \
    /javaagent.jar

FROM openjdk:11.0.16-slim AS downstreamcallerservice
EXPOSE 8000

WORKDIR /app

COPY --from=microservicebuilder /builder/microservices/downstream-caller-service/dependencies ./
COPY --from=microservicebuilder /builder/microservices/downstream-caller-service/spring-boot-loader ./
COPY --from=microservicebuilder /builder/microservices/downstream-caller-service/snapshot-dependencies ./
COPY --from=microservicebuilder /builder/microservices/downstream-caller-service/build/reports/vulnerabilitytracer-dependencies.json ./
COPY --from=microservicebuilder /builder/microservices/downstream-caller-service/application ./

CMD ["java", "org.springframework.boot.loader.JarLauncher"]

FROM openjdk:11.0.16-slim AS generatorservice
EXPOSE 8000

WORKDIR /app

COPY --from=microservicebuilder /builder/microservices/generator-service/dependencies ./
COPY --from=microservicebuilder /builder/microservices/generator-service/spring-boot-loader ./
COPY --from=microservicebuilder /builder/microservices/generator-service/snapshot-dependencies ./
COPY --from=microservicebuilder /builder/microservices/generator-service/build/reports/vulnerabilitytracer-dependencies.json ./
COPY --from=microservicebuilder /builder/microservices/generator-service/application ./

CMD ["java", "org.springframework.boot.loader.JarLauncher"]