FROM openjdk:17.0-jdk-bullseye AS basebuilder
ENV GRADLE_USER_HOME "/gradle-home"

ARG OTEL_JAVA_AGENT_URL="https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v1.21.0/opentelemetry-javaagent.jar"

RUN curl -L -o /tmp/opentelemetry-javaagent.jar ${OTEL_JAVA_AGENT_URL}

WORKDIR /builder

COPY settings.gradle.kts gradlew ./
COPY gradle gradle
COPY buildSrc buildSrc

FROM basebuilder AS microservicebuilder

COPY microservice microservice

RUN --mount=type=cache,target=/gradle-home \
    ./gradlew assemble dependencyCheckAnalyze --no-daemon \
    && java -Djarmode=layertools -jar microservice/build/libs/microservice.jar extract

FROM basebuilder AS javaagentbuilder

COPY vulnerabilitytracer-javaagent vulnerabilitytracer-javaagent

RUN --mount=type=cache,target=/gradle-home \
    ./gradlew assemble --no-daemon

FROM openjdk:17.0-slim AS final
EXPOSE 8000

ENV JAVA_TOOL_OPTIONS "-javaagent:opentelemetry-javaagent.jar"
ENV OTEL_JAVAAGENT_EXTENSIONS "vulnerabilitytracer-javaagent-all.jar"
ENV OTEL_SERVICE_NAME "microservice"
ENV OTEL_PROPAGATORS "b3"

WORKDIR /app

COPY --from=microservicebuilder /tmp/opentelemetry-javaagent.jar .

COPY --from=microservicebuilder /builder/dependencies ./
COPY --from=microservicebuilder /builder/spring-boot-loader ./
COPY --from=microservicebuilder /builder/snapshot-dependencies ./
COPY --from=microservicebuilder /builder/application ./

COPY --from=javaagentbuilder /builder/vulnerabilitytracer-javaagent/build/libs/vulnerabilitytracer-javaagent-all.jar ./

CMD ["java", "org.springframework.boot.loader.JarLauncher"]