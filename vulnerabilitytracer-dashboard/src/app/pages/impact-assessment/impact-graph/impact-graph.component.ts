import {AfterViewInit, Component, ElementRef, Input, OnInit, ViewChild} from '@angular/core';
import {DataSet} from 'vis-data/esnext';
import {Network} from 'vis-network/esnext';
import {ImpactGraph} from "./impact-graph";

const SERVICE_COLOR = '#2563eb';
const VULNERABLE_SERVICE_COLOR = '#ef4444';

@Component({
  selector: 'app-impact-graph',
  standalone: true,
  imports: [],
  templateUrl: './impact-graph.component.html',
  styleUrl: './impact-graph.component.scss'
})
export class ImpactGraphComponent implements AfterViewInit {

  @ViewChild('graphElement') graphElement: ElementRef;

  _graph: ImpactGraph;

  get graph(): ImpactGraph {
    return this._graph;
  }

  @Input()
  set graph(value: ImpactGraph) {
    this._graph = value;
    if (this._graph) {
      this.buildGraph();
    }
  }

  constructor() {}

  ngAfterViewInit(): void {
    this.buildGraph()
  }

  private buildGraph() {
    if (!this.graphElement || !this.graph) {
      return;
    }

    let nodes = new DataSet();
    let edges = new DataSet();

    for (let node of this.graph.nodes) {
      nodes.add({
        id: node.id,
        // @ts-ignore
        label: node.serviceName,
        color: node.isVulnerable ? VULNERABLE_SERVICE_COLOR : SERVICE_COLOR,
        font: {vadjust: 50}
      });
    }

    for (let edge of this.graph.edges) {
      edges.add({
        // @ts-ignore
        from: edge.sourceNodeId,
        to: edge.targetNodeId,
        label: edge.label,
        font: {align: 'top'},
        arrows: 'to'
      });
    }

    let data = {
      nodes: nodes,
      edges: edges
    };
    let options = {
      nodes: {
        shape: 'circle',
      },
      layout: {
        randomSeed: undefined,
        improvedLayout:true
      },
      physics: {
        enabled: true,
        barnesHut: {
          gravitationalConstant: -20000,
          centralGravity: 0.3,
          springLength: 95,
          springConstant: 0.04,
          damping: 0.09,
          avoidOverlap: 0.1
        },
        solver: 'barnesHut'
      }
    };

    // @ts-ignore
    new Network(this.graphElement.nativeElement, data, options);
  }

}
