FROM node:20.11 AS builder

RUN apt update \
    && apt install -y openjdk-17-jre \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /builder
COPY package.json package-lock.json ./

RUN --mount=type=cache,target=/root/.npm/_cacache npm install
RUN npx openapi-generator-cli version

COPY . .
RUN --mount=type=cache,target=/builder/.angular/cache \
    npm run build

FROM nginx:1.21-alpine AS final

COPY --from=builder /builder/dist/vulnerabilitytracer-dashboard/browser /srv/
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf
