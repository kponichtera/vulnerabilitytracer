version: 3

vars:
  KUBE_SERVICE: "{{.KUBE_SERVICE}}"
  KUBE_SERVICE_PORT: "{{.KUBE_SERVICE_PORT}}"

tasks:
  intercept:
    deps: [":connect"]
    desc: >-
      Intercept connections to service {{.KUBE_SERVICE}}:{{.KUBE_SERVICE_PORT}}
      and redirect them to host's loopback interface on the same port (127.0.0.1:{{.KUBE_SERVICE_PORT}})
    cmd: "telepresence intercept {{.KUBE_SERVICE}} --port {{.KUBE_SERVICE_PORT}}:{{.KUBE_SERVICE_PORT}}"
  leave:
    desc: "Stop intercepting connections to 127.0.0.1:{{.KUBE_SERVICE_PORT}}"
    cmd: "telepresence leave {{.KUBE_SERVICE}}"