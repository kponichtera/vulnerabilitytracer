FROM openjdk:17.0-jdk-bullseye AS builder
ENV GRADLE_USER_HOME '/gradle-home'

WORKDIR /builder

COPY . .

RUN --mount=type=cache,target=/gradle-home \
    ./gradlew assemble --no-daemon \
    && java -Djarmode=layertools -jar build/libs/microservice.jar extract

FROM openjdk:17.0-slim AS final
EXPOSE 8000

WORKDIR /app

COPY --from=builder /builder/dependencies ./
COPY --from=builder /builder/spring-boot-loader ./
COPY --from=builder /builder/snapshot-dependencies ./
COPY --from=builder /builder/application ./

CMD ["java", "org.springframework.boot.loader.JarLauncher"]