###################
### Java schema ###
###################

schema "java" {}

table "dependencies" {
  schema = schema.java

  column "id" {
    type = bigserial
  }

  column "group_id" {
    type = varchar
  }

  column "artifact_id" {
    type = varchar
  }

  column "version" {
    type = varchar(255)
  }

  column "creation_time" {
    type    = timestamptz
    default = sql("now()")
  }

  column "fasten_processed" {
    type = boolean
  }

  column "vulnerability_update_time" {
    type = timestamptz
    null = true
  }

  primary_key {
    columns = [column.id]
  }

  index "depenedency_maven_coordinates" {
    columns = [
      column.group_id,
      column.artifact_id,
      column.version
    ]
    unique = true
  }

}

table "callables" {
  schema = schema.java

  column "id" {
    type = bigserial
  }

  column "fasten_id" {
    type = varchar
  }

  column "package_name" {
    type = varchar(255)
  }

  column "class_name" {
    type = varchar(255)
  }

  column "method_name" {
    type = varchar(255)
  }

  column "creation_time" {
    type    = timestamptz
    default = sql("now()")
  }

  primary_key {
    columns = [column.id]
  }

  index "fasten_id" {
    columns = [
      column.fasten_id,
    ]
    unique = true
  }

}

table "callables_vulnerabilities" {
  schema = schema.java

  column "callable_id" {
    type = bigint
  }

  column "vulnerability_id" {
    type = bigint
  }

  primary_key {
    columns = [
      column.callable_id,
      column.vulnerability_id
    ]
  }

  foreign_key "callables_fk" {
    columns     = [column.callable_id]
    ref_columns = [table.callables.column.id]
  }

  foreign_key "vulnerability_fk" {
    columns     = [column.vulnerability_id]
    ref_columns = [table.vulnerabilities.column.id]
  }

}

table "dependencies_vulnerabilities" {
  schema = schema.java

  column "dependency_id" {
    type = bigint
  }

  column "vulnerability_id" {
    type = bigint
  }

  primary_key {
    columns = [
      column.dependency_id,
      column.vulnerability_id
    ]
  }

  foreign_key "dependencies_fk" {
    columns     = [column.dependency_id]
    ref_columns = [table.dependencies.column.id]
  }

  foreign_key "vulnerability_fk" {
    columns     = [column.vulnerability_id]
    ref_columns = [table.vulnerabilities.column.id]
  }

}

##############################
### Vulnerabilities schema ###
##############################

schema "vulnerabilities" {}

enum "severity" {
  schema = schema.vulnerabilities
  values = [
    "UNDEFINED", "LOW", "MODERATE", "MEDIUM", "HIGH", "CRITICAL",
  ]
}

table "vulnerabilities" {
  schema = schema.vulnerabilities

  column "id" {
    type = bigserial
  }

  column "external_id" {
    type = varchar(255)
  }

  column "severity" {
    type = enum.severity
  }

  column "creation_time" {
    type    = timestamptz
    default = sql("now()")
  }

  primary_key {
    columns = [column.id]
  }

  index "external_id" {
    columns = [
      column.external_id,
    ]
    unique = true
  }

}

######################
### Service schema ###
######################

schema "service" {}

enum "mitigation_strategy_type" {
  schema = schema.service
  values = [
    "NONE", "ERROR", "NOOP",
  ]
}

table "services" {
  schema = schema.service

  column "id" {
    type = bigserial
  }

  column "name" {
    type = varchar(255)
  }

  column "dependencies_hash" {
    type = varchar(255)
  }

  column "registration_time" {
    type    = timestamptz
    default = sql("now()")
  }

  primary_key {
    columns = [column.id]
  }

  index "name" {
    columns = [
      column.name,
      column.dependencies_hash,
    ]
    unique = true
  }

}

table "service_dependencies" {
  schema = schema.service

  column "service_id" {
    type = bigint
  }

  column "dependency_id" {
    type = bigint
  }

  primary_key {
    columns = [
      column.service_id,
      column.dependency_id
    ]
  }

  foreign_key "services_fk" {
    columns     = [column.service_id]
    ref_columns = [table.services.column.id]
  }

  foreign_key "dependencies_fk" {
    columns     = [column.dependency_id]
    ref_columns = [table.dependencies.column.id]
  }

}

table "mitigation_strategies" {
  schema = schema.service

  column "service_id" {
    type = bigint
  }

  column "callable_id" {
    type = bigint
  }

  column "strategy" {
    type    = enum.mitigation_strategy_type
  }

  primary_key {
    columns = [
      column.service_id,
      column.callable_id
    ]
  }

  foreign_key "services_fk" {
    columns     = [column.service_id]
    ref_columns = [table.services.column.id]
  }

  foreign_key "callables_fg" {
    columns     = [column.callable_id]
    ref_columns = [table.callables.column.id]
  }

}

view "latest_services" {
  schema = schema.service

  column "id" {
    type = bigserial
  }

  column "name" {
    type = varchar(255)
  }

  column "dependencies_hash" {
    type = varchar(255)
  }

  column "registration_time" {
    type    = timestamptz
  }

  as = <<-SQL
    SELECT DISTINCT ON (name) id, name, dependencies_hash, registration_time
    FROM ${schema.service.name}.${table.services.name}
    ORDER BY name, registration_time DESC;
  SQL

}

######################
### Service schema ###
######################

schema "trace" {}

table "traces" {
  schema = schema.trace

  column "id" {
    type = bigserial
  }

  column "tempo_id" {
    type = varchar(255)
  }

  column "service_id" {
    type = bigint
  }

  column "scraped" {
    type    = boolean
    default = false
  }

  column "time" {
    type    = timestamptz
    default = sql("now()")
  }

  primary_key {
    columns = [column.id]
  }

  foreign_key "services_fk" {
    columns     = [column.service_id]
    ref_columns = [table.services.column.id]
  }

  index "tempo_id" {
    columns = [
      column.tempo_id,
    ]
    unique = true
  }

}

table "events" {
  schema = schema.trace

  column "id" {
    type = bigserial
  }

  column "callable_fasten_id" {
    type = varchar
  }

  column "trace_id" {
    type = bigint
  }

  column "severity" {
    type = enum.severity
  }

  column "time" {
    type    = timestamptz
    default = sql("now()")
  }

  column "mitigation_strategy" {
    type    = enum.mitigation_strategy_type
  }

  column "vulnerability_external_id" {
    type = varchar(255)
  }

  primary_key {
    columns = [column.id]
  }

  foreign_key "traces_fk" {
    columns     = [column.trace_id]
    ref_columns = [table.traces.column.id]
  }

  foreign_key "callables_fk" {
    columns     = [column.callable_fasten_id]
    ref_columns = [table.callables.column.fasten_id]
  }

  foreign_key "vulnerabilities_fk" {
    columns     = [column.vulnerability_external_id]
    ref_columns = [table.vulnerabilities.column.external_id]
  }

}