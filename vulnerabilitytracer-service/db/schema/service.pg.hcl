schema "service" {}

table "services" {
  schema = schema.service

  column "id" {
    type = bigserial
  }

  column "name" {
    type = varchar(255)
  }

  column "dependencies_hash" {
    type = varchar(255)
  }

  column "registration_time" {
    type    = timestamptz
    default = sql("now()")
  }

  primary_key {
    columns = [column.id]
  }

  index "name" {
    columns = [
      column.name,
      column.dependencies_hash,
    ]
    unique = true
  }

}

table "service_dependencies" {
  schema = schema.service

  column "service_id" {
    type = bigint
  }

  column "dependency_id" {
    type = bigint
  }

  primary_key {
    columns = [
      column.service_id,
      column.dependency_id
    ]
  }

  foreign_key "services_fk" {
    columns     = [column.service_id]
    ref_columns = [table.services.column.id]
  }

  foreign_key "dependencies_fk" {
    columns     = [column.dependency_id]
    ref_columns = [table.dependencies.column.id]
  }

}
