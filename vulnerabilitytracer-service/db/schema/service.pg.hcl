schema "service" {}

# FIXME: Bug in Atlas, enums are not created in the first migration and require running apply two times.
#  https://github.com/ariga/atlas/issues/2156
#enum "mitigation_strategy" {
#  schema = schema.service
#  values = [
#    "ERROR", "NOOP",
#  ]
#}

table "services" {
  schema = schema.service

  column "id" {
    type = bigserial
  }

  column "name" {
    type = varchar(255)
  }

  column "dependencies_hash" {
    type = varchar(255)
  }

  column "registration_time" {
    type    = timestamptz
    default = sql("now()")
  }

  primary_key {
    columns = [column.id]
  }

  index "name" {
    columns = [
      column.name,
      column.dependencies_hash,
    ]
    unique = true
  }

}

table "service_dependencies" {
  schema = schema.service

  column "service_id" {
    type = bigint
  }

  column "dependency_id" {
    type = bigint
  }

  primary_key {
    columns = [
      column.service_id,
      column.dependency_id
    ]
  }

  foreign_key "services_fk" {
    columns     = [column.service_id]
    ref_columns = [table.services.column.id]
  }

  foreign_key "dependencies_fk" {
    columns     = [column.dependency_id]
    ref_columns = [table.dependencies.column.id]
  }

}

table "mitigation_strategies" {
  schema = schema.service

  column "service_id" {
    type = bigint
  }

  column "callable_id" {
    type = bigint
  }

  column "strategy" {
    type    = varchar(255)
  }

  primary_key {
    columns = [
      column.service_id,
      column.callable_id
    ]
  }

  foreign_key "services_fk" {
    columns     = [column.service_id]
    ref_columns = [table.services.column.id]
  }

  foreign_key "callables_fg" {
    columns     = [column.callable_id]
    ref_columns = [table.callables.column.id]
  }

  check "strategy" {
    expr = "strategy in ('ERROR', 'NOOP')"
  }

}