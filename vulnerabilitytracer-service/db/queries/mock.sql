-- name: CreateMockVulnerability :exec
WITH inserted_vulnerability AS (
    INSERT INTO vulnerabilities.vulnerabilities (external_id, severity)
        VALUES ($1, $2)
        RETURNING id
), selected_dependency AS (
    SELECT id FROM java.dependencies WHERE group_id = $3 AND artifact_id = $4 AND version = $5
)
INSERT INTO java.dependencies_vulnerabilities (vulnerability_id, dependency_id)
SELECT inserted_vulnerability.id, selected_dependency.id
FROM inserted_vulnerability, selected_dependency;

-- name: CreateMockCallable :one
WITH inserted_callable AS (
    INSERT INTO java.callables (fasten_id, package_name, class_name, method_name)
        VALUES ($1, $2, $3, $4)
        RETURNING id
), vulnerabilities AS (
    SELECT id FROM vulnerabilities.vulnerabilities WHERE external_id = ANY(@vulnerability_external_ids::varchar[])
)
INSERT INTO java.callables_vulnerabilities (callable_id, vulnerability_id)
SELECT inserted_callable.id, vulnerabilities.id
FROM inserted_callable, vulnerabilities
RETURNING callable_id;

-- name: CreateMockMitigationStrategy :exec
WITH service AS (
    SELECT id FROM service.services WHERE name = $1
)
INSERT INTO service.mitigation_strategies (service_id, callable_id, strategy)
SELECT service.id, $2, $3
FROM service;