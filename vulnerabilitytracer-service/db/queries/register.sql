-- name: GetServiceForRegistration :one
SELECT (id)
FROM service.services
WHERE name = $1
  AND dependencies_hash = $2;

-- name: RegisterNewService :one
INSERT INTO service.services (name, dependencies_hash)
VALUES ($1, $2)
RETURNING id;

-- name: GetServiceDependenciesForRegistration :many
SELECT d.id, d.group_id, d.artifact_id, d.version
FROM service.services s
         JOIN service.service_dependencies sd ON s.id = sd.service_id
         JOIN java.dependencies d ON s.id = sd.dependency_id
WHERE s.name = $1
  AND s.dependencies_hash = $2;

-- name: RegisterNewDependency :one
INSERT INTO java.dependencies (group_id, artifact_id, version, fasten_processed)
VALUES ($1, $2, $3, $4)
RETURNING id;

-- name: GetVulnerabilitiesForRegistration :many
SELECT v.id, v.external_id
FROM vulnerabilities.vulnerabilities v
WHERE v.external_id = ANY($1::varchar[]);

-- name: GetCallablesForRegistration :many
SELECT c.id, c.fasten_id
FROM java.callables c
WHERE c.fasten_id = ANY($1::varchar[]);

-- name: RegisterNewCallable :one
INSERT INTO java.callables (fasten_id, package_name, class_name, method_name)
VALUES ($1, $2, $3, $4)
RETURNING id;

-- name: RegisterNewVulnerability :one
INSERT INTO vulnerabilities.vulnerabilities (external_id, severity)
VALUES ($1, $2)
RETURNING id;

-- name: RegisterVulnerabilityCallableRelations :copyfrom
INSERT INTO java.callables_vulnerabilities (callable_id, vulnerability_id)
VALUES ($1, $2);

-- name: RegisterServiceDependencies :copyfrom
INSERT INTO service.service_dependencies (service_id, dependency_id)
VALUES ($1, $2);

-- name: RegisterDependencyVulnerabilities :copyfrom
INSERT INTO java.dependencies_vulnerabilities (dependency_id, vulnerability_id)
VALUES ($1, $2);
