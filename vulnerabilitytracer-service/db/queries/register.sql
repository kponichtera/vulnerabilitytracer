-- name: GetServiceForRegistration :one
SELECT (id) FROM service.services WHERE name = $1 AND dependencies_hash = $2;

-- name: RegisterNewService :one
INSERT INTO service.services (name, dependencies_hash) VALUES ($1, $2) RETURNING id;

-- name: GetServiceDependenciesForRegistration :many
SELECT d.id, d.group_id, d.artifact_id, d.version
    FROM service.services s
    JOIN service.service_dependencies sd ON s.id = sd.service_id
    JOIN java.dependencies d ON s.id = sd.dependency_id
    WHERE s.name = $1 AND s.dependencies_hash = $2;

-- name: RegisterNewDependency :one
INSERT INTO java.dependencies (group_id, artifact_id, version)
    VALUES ($1, $2, $3)
    ON CONFLICT(group_id, artifact_id, version) DO UPDATE SET last_service_registration_time = NOW()
    RETURNING id;

-- name: RegisterServiceDependencies :copyfrom
INSERT INTO service.service_dependencies (service_id, dependency_id)
VALUES ($1, $2);
