-- name: GetDashboardNotifications :many
SELECT n.id, n.type, n.severity, s.name AS service_name, v.external_id AS vulnerability_external_id
FROM notifications.notifications n
         LEFT JOIN service.services s ON n.service_id = s.id
         LEFT JOIN vulnerabilities.vulnerabilities v ON n.vulnerability_id = v.id
WHERE n.dismissed = FALSE
ORDER BY time;

-- name: DismissNotification :exec
UPDATE notifications.notifications
SET dismissed = TRUE
WHERE id = @notification_id;

-- name: DismissServiceRestartNotifications :exec
UPDATE notifications.notifications
SET dismissed = TRUE
WHERE service_id = @service_id
  AND type IN ('NEW_VULNERABILITY_IN_SERVICE', 'MITIGATION_APPLIED');

-- name: GetVulnerabilityNotifications :many
SELECT n.id, n.type, n.severity, s.id AS service_id, s.name AS service_name
FROM notifications.notifications n
         JOIN service.services s ON n.service_id = s.id
         JOIN vulnerabilities.vulnerabilities v ON n.vulnerability_id = v.id
WHERE n.dismissed = FALSE
  AND v.external_id = @vulnerability_external_id
ORDER BY time;

-- name: CreateNewVulnerabilityNotification :exec
INSERT INTO notifications.notifications (type, severity, service_id, vulnerability_id)
SELECT 'NEW_VULNERABILITY_IN_SERVICE', @severity, @service_id, v.id
FROM vulnerabilities.vulnerabilities v
WHERE v.external_id = @vulnerability_external_id;

-- name: CreateNewMitigationAppliedNotification :exec
WITH vulnerability AS (
    SELECT cv.vulnerability_id
    FROM java.callables_vulnerabilities cv
    WHERE cv.callable_id = @callable_id
)
INSERT INTO notifications.notifications (type, severity, service_id, vulnerability_id)
SELECT 'MITIGATION_APPLIED', @severity, @service_id, vulnerability.vulnerability_id
FROM vulnerability;