package processor

import (
	"context"
	"fmt"
	"time"

	"vulnerabilitytracer/internal/runtime"

	"github.com/go-co-op/gocron"
	"github.com/sirupsen/logrus"
)

func RunScheduler(runtimeCtx runtime.Context, config Config, processorJobFunc JobFunc) (*gocron.Scheduler, error) {
	scheduler := gocron.NewScheduler(time.UTC).
		SingletonMode().
		Every(config.JobDelay)

	_, err := scheduler.DoWithJobDetails(jobFunc, runtimeCtx, config.JobTimeout, processorJobFunc)
	if err != nil {
		return nil, fmt.Errorf("error when scheduling job: %w", err)
	}

	scheduler.StartAsync()

	return scheduler, nil
}

func jobFunc(runtimeCtx runtime.Context, timeout time.Duration, processorJobFunc JobFunc, job gocron.Job) {
	ctx, cancel := context.WithTimeout(job.Context(), timeout)
	defer cancel()

	logrus.
		WithField("runCount", job.RunCount()).
		Info("Starting the processor job")

	err := processorJobFunc(ctx, runtimeCtx)
	if err != nil {
		logrus.WithError(err).Error("error when running processor job")
	}
}
