FROM docker.io/library/golang:1.21 AS builder-base

COPY docker/builder/install_go_tools.sh /tmp/install_go_tools.sh
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    /tmp/install_go_tools.sh

WORKDIR /project

FROM builder-base AS builder

ENV GOPATH=/home/builder/go
ENV PATH=$PATH:/home/builder/go/bin

FROM builder-base AS api-builder

COPY . .
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task api:build

FROM builder-base AS dependencyprocessor-builder

COPY . .
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task dependencyprocessor:build

FROM builder-base AS vulnerabilityupdaterprocessor-builder

COPY . .
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task vulnerabilityupdaterprocessor:build

FROM alpine:3.18 AS runtime

RUN adduser -S app
RUN apk add --no-cache dumb-init

FROM runtime AS api-runtime

COPY --from=api-builder /project/out/bin/api /usr/local/bin/vulnerabilitytracer-api
USER app

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/usr/local/bin/vulnerabilitytracer-api"]
CMD ["--prefork"]

FROM runtime AS dependencyprocessor-runtime

COPY --from=dependencyprocessor-builder /project/out/bin/dependencyprocessor /usr/local/bin/vulnerabilitytracer-dependencyprocessor
USER app

ENTRYPOINT ["/usr/local/bin/vulnerabilitytracer-dependencyprocessor"]
CMD ["--server"]

FROM runtime AS vulnerabilityupdaterprocessor-runtime

COPY --from=dependencyprocessor-builder /project/out/bin/vulnerabilityupdaterprocessor /usr/local/bin/vulnerabilitytracer-vulnerabilityupdaterprocessor
USER app

ENTRYPOINT ["/usr/local/bin/vulnerabilitytracer-vulnerabilityupdaterprocessor"]
CMD ["--server"]