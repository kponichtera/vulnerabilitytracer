FROM docker.io/library/golang:1.21 AS builder-base

COPY docker/builder/install_go_tools.sh /tmp/install_go_tools.sh
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    /tmp/install_go_tools.sh

WORKDIR /project

FROM builder-base AS builder

ENV GOPATH=/home/builder/go
ENV PATH=$PATH:/home/builder/go/bin

FROM builder-base AS coordinator-builder

COPY . .
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task coordinator:build

FROM builder-base AS manager-builder

COPY . .
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task manager:build

FROM alpine:3.18 AS runtime

RUN adduser -S app
RUN apk add --no-cache dumb-init

FROM runtime AS coordinator-runtime

COPY --from=coordinator-builder /project/out/bin/coordinator /usr/local/bin/coordinator
USER app

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/usr/local/bin/coordinator"]
CMD ["--prefork"]

FROM runtime AS manager-runtime

COPY --from=manager-builder /project/out/bin/manager /usr/local/bin/manager
USER app

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/usr/local/bin/manager"]
CMD ["--prefork"]

