package service

import (
	"context"
	"fmt"

	"vulnerabilitytracer-service/api/generated/api"
	"vulnerabilitytracer-service/pkg/server/runtime"

	"github.com/sirupsen/logrus"
)

func QueryServiceVulnerableCallables(ctx context.Context, runtimeCtx runtime.Context,
	serviceID int64,
) ([]api.JavaCallable, error) {
	vulnerableCallables, err := runtimeCtx.DBQueries.GetServiceVulnerableCallables(ctx, serviceID)
	if err != nil {
		logrus.
			WithError(err).
			WithField("serviceID", serviceID).
			Error("error when fetching vulnerable callables from database")

		return nil, fmt.Errorf("error when fetching vulnerable callables from database: %w", err)
	}

	apiCallables := make([]api.JavaCallable, len(vulnerableCallables))
	for i, callable := range vulnerableCallables {
		// TODO: Implement mitigation strategy
		apiCallables[i] = api.JavaCallable{
			ClassName:          callable.ClassName,
			MethodName:         callable.MethodName,
			PackageName:        callable.PackageName,
			MitigationStrategy: api.NoneMitigationStrategy,
		}
	}

	logrus.
		WithField("serviceID", serviceID).
		WithField("callableCount", len(apiCallables)).
		Info("fetched vulnerable callables from database")

	return apiCallables, nil
}
