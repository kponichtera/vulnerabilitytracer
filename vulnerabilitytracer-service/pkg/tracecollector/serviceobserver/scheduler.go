package serviceobserver

import (
	"context"
	"fmt"
	"os"
	"os/signal"
	"syscall"
	"time"

	"vulnerabilitytracer/pkg/tracecollector"
	"vulnerabilitytracer/pkg/tracecollector/runtime"

	"github.com/go-co-op/gocron"
	"github.com/sirupsen/logrus"
)

const (
	observerJobTimeout                = 5 * time.Second
	serviceObserverJobIntervalSeconds = 5
)

type Context struct {
	runtime.Context
	ObservedServices map[string]*gocron.Scheduler
	ScrapeDelay      time.Duration
	ScrapeInterval   time.Duration
}

func Run(config tracecollector.Config) error {
	runtimeCtx, err := runtime.Build(config.Tempo, config.Database)
	if err != nil {
		return fmt.Errorf("error when building runtime context: %w", err)
	}

	defer runtimeCtx.Close()

	serviceObserverCtx := &Context{
		Context:          *runtimeCtx,
		ObservedServices: make(map[string]*gocron.Scheduler),
		ScrapeDelay:      config.ScrapeDelay,
		ScrapeInterval:   config.ScrapeInterval,
	}

	scheduler := gocron.NewScheduler(time.UTC).
		SingletonMode().
		Every(serviceObserverJobIntervalSeconds).Seconds()

	_, err = scheduler.DoWithJobDetails(observerJobFunc, serviceObserverCtx)
	if err != nil {
		return fmt.Errorf("error when scheduling observer job: %w", err)
	}

	go func() {
		// Shutdown procedure
		shutdown := make(chan os.Signal, 1)
		signal.Notify(shutdown, syscall.SIGINT, syscall.SIGTERM)

		received := <-shutdown
		logrus.Infof("%s signal received, shutting down the scrapers", received.String())

		for serviceName, scraperScheduler := range serviceObserverCtx.ObservedServices {
			logrus.Infof("shutting down the scraper for service %s", serviceName)
			scraperScheduler.Stop()
		}

		logrus.Info("shutting down the observer")
		scheduler.Stop()
	}()

	scheduler.StartBlocking()
	logrus.Info("scheduler shutdown complete")

	return nil
}

func observerJobFunc(runtimeCtx *Context, job gocron.Job) {
	ctx, cancel := context.WithTimeout(job.Context(), observerJobTimeout)
	defer cancel()

	err := reconcile(ctx, runtimeCtx)
	if err != nil {
		logrus.WithError(err).Error("error during reconciliation")
	}
}
