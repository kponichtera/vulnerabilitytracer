package fasten_test

import (
	"context"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
	"net/http"
	"testing"
	"vulnerabilitytracer-service/api/generated/fastenapi"
	"vulnerabilitytracer-service/pkg/fasten"
)

type mockHTTPClient struct {
	mock.Mock
}

func (m *mockHTTPClient) Do(req *http.Request) (*http.Response, error) {
	args := m.Called(req)
	return args.Get(0).(*http.Response), args.Error(1)
}

func makeMockClient(t *testing.T) (*fastenapi.ClientWithResponses, *mockHTTPClient) {
	t.Helper()
	mockClient := new(mockHTTPClient)

	client, err := fastenapi.NewClientWithResponses("http://localhost:8080", func(client *fastenapi.Client) error {
		client.Client = mockClient
		return nil
	})
	if err != nil {
		t.Fatalf("error when creating FASTEN API client: %v", err)
	}

	return client, mockClient
}

func makePackageResponse(t *testing.T, statusCode int) http.Response {
	t.Helper()
	return http.Response{
		StatusCode: statusCode,
		Body:       http.NoBody,
	}
}

func TestGetPackageWithoutBody(t *testing.T) {
	t.Parallel()

	type args struct {
		mockClientResponse http.Response
		mockClientError    error
	}

	tests := []struct {
		name    string
		args    args
		want    fasten.PackageStatus
		wantErr bool
	}{
		{
			name: "package request for processed package works",
			args: args{
				mockClientResponse: makePackageResponse(t, http.StatusOK),
				mockClientError:    nil,
			},
			want:    fasten.PackageStatusProcessed,
			wantErr: false,
		},
		{
			name: "package request for new package works",
			args: args{
				mockClientResponse: makePackageResponse(t, http.StatusCreated),
				mockClientError:    nil,
			},
			want:    fasten.PackageStatusQueued,
			wantErr: false,
		},
		{
			name: "unexpected response results in an error",
			args: args{
				mockClientResponse: makePackageResponse(t, http.StatusBadGateway),
				mockClientError:    nil,
			},
			want:    fasten.PackageStatusUnknown,
			wantErr: true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Given
			client, mockClient := makeMockClient(t)

			// And
			mockClient.On("Do", mock.Anything).Return(&tt.args.mockClientResponse, tt.args.mockClientError)

			got, err := fasten.GetPackageWithoutBody(
				context.Background(), client,
				"org.latencyutils", "LatencyUtils", "1.2.3",
			)

			assert.Equal(t, tt.want, got)

			if tt.wantErr {
				assert.Error(t, err)
			} else {
				assert.NoError(t, err)
			}
		})
	}
}
