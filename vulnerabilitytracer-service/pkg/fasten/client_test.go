package fasten_test

import (
	"context"
	"io"
	"net/http"
	"strings"
	"testing"

	"github.com/stretchr/testify/require"

	"vulnerabilitytracer-service/api/generated/fastenapi"
	"vulnerabilitytracer-service/pkg/fasten"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
)

type mockHTTPClient struct {
	mock.Mock
}

func (m *mockHTTPClient) Do(req *http.Request) (*http.Response, error) {
	args := m.Called(req)

	//nolint:forcetypeassert
	return args.Get(0).(*http.Response), args.Error(1)
}

func makeMockClient(t *testing.T) (*fastenapi.ClientWithResponses, *mockHTTPClient) {
	t.Helper()

	mockClient := new(mockHTTPClient)

	client, err := fastenapi.NewClientWithResponses("http://localhost:8080", func(client *fastenapi.Client) error {
		client.Client = mockClient
		return nil
	})
	if err != nil {
		t.Fatalf("error when creating FASTEN API client: %v", err)
	}

	return client, mockClient
}

func makeEmptyArrayResponse(t *testing.T) http.Response {
	t.Helper()

	return http.Response{
		StatusCode: http.StatusOK,
		Header: map[string][]string{
			"Content-Type": {"application/json"},
		},
		Body: io.NopCloser(strings.NewReader("[]")),
	}
}

func makeEmptyObjectResponse(t *testing.T) http.Response {
	t.Helper()

	return http.Response{
		StatusCode: http.StatusOK,
		Header: map[string][]string{
			"Content-Type": {"application/json"},
		},
		Body: io.NopCloser(strings.NewReader("{}")),
	}
}

func makeSimplePackageResponse(t *testing.T, statusCode int) http.Response {
	t.Helper()

	var (
		body        string
		contentType string
	)

	if statusCode == http.StatusOK {
		contentType = "application/json"
		body = `
		[{
			"id": 17,
			"package_id": 25,
			"version": "2.17.0",
			"cg_generator": "OPAL",
			"repository_base_url": "https://repo.maven.apache.org/maven2/",
			"metadata": {}
        }]
	`
	} else {
		contentType = "text/plain"
		body = "Plain text return body for non-200 responses"
	}

	return http.Response{
		StatusCode: statusCode,
		Header: map[string][]string{
			"Content-Type": {contentType},
		},
		Body: io.NopCloser(strings.NewReader(body)),
	}
}

func makeSimpleVulnerabilitiesResponse(t *testing.T, statusCode int) http.Response {
	t.Helper()

	body := `
		[
			{
				"statement": {
					"id": "CVE-2021-44832"
				},
				"external_id": "CVE-2021-44832",
				"id": 29961
			}
		]
	`

	return http.Response{
		StatusCode: statusCode,
		Header: map[string][]string{
			"Content-Type": {"application/json"},
		},
		Body: io.NopCloser(strings.NewReader(body)),
	}
}

func makeVulnerableCallablesResponse(t *testing.T, statusCode int) http.Response {
	t.Helper()

	body := `
		{
        	"1266843": "fasten://mvn!dom4j:dom4j$1.6/org.dom4j.io/SAXReader.setIncludeExternalDTDDeclarations(%2Fjava.lang%2FBooleanType)%2Fjava.lang%2FVoidType",
        	"1266844": "fasten://mvn!dom4j:dom4j$1.6/org.dom4j.io/SAXReader.setDispatchHandler(DispatchHandler)%2Fjava.lang%2FVoidType",
        	"1266841": "fasten://mvn!dom4j:dom4j$1.6/org.dom4j.io/SAXReader.%3Cinit%3E(%2Forg.dom4j%2FDocumentFactory,%2Fjava.lang%2FBooleanType)%2Fjava.lang%2FVoidType"
        }
	`

	return http.Response{
		StatusCode: statusCode,
		Header: map[string][]string{
			"Content-Type": {"application/json"},
		},
		Body: io.NopCloser(strings.NewReader(body)),
	}
}

func makeCallablesResponse(t *testing.T, statusCode int) http.Response {
	t.Helper()

	body := `
		{
            "32548": {
                "is_internal_call": true,
                "metadata": {
                    "quality": {
                        "quality_analysis_timestamp": "1676462882.74734",
                        "callable_long_name": "JpaSort::JpaOrder::isIgnoreCase()",
                        "quality_analyzer_version": "1.17.10",
                        "callable_parameters": [],
                        "rapid_plugin_version": "1.3.0",
                        "metrics": {
                            "nloc": 3,
                            "complexity": 2,
                            "token_count": 14,
                            "parameter_count": 0,
                            "length": 3
                        },
                        "quality_analyzer_name": "Lizard",
                        "rapid_metadata_plugin_version": "1.2.2",
                        "callable_name": "JpaSort::JpaOrder::isIgnoreCase"
                  }
              },
              "module_id": 4576,
              "line_start": 411,
              "fasten_uri": "/org.springframework.data.jpa.domain/JpaSort$JpaOrder.isIgnoreCase()%2Fjava.lang%2FBooleanType",
              "line_end": 411
			}
		}
	`

	return http.Response{
		StatusCode: statusCode,
		Header: map[string][]string{
			"Content-Type": {"application/json"},
		},
		Body: io.NopCloser(strings.NewReader(body)),
	}
}

func TestGetPackageWithoutBody(t *testing.T) {
	t.Parallel()

	type args struct {
		mockClientResponse http.Response
		mockClientError    error
	}

	tests := []struct {
		name    string
		args    args
		want    fasten.PackageStatus
		wantErr bool
	}{
		{
			name: "package request for processed package works",
			args: args{
				mockClientResponse: makeSimplePackageResponse(t, http.StatusOK),
				mockClientError:    nil,
			},
			want:    fasten.PackageStatusProcessed,
			wantErr: false,
		},
		{
			name: "package request for new package works",
			args: args{
				mockClientResponse: makeSimplePackageResponse(t, http.StatusCreated),
				mockClientError:    nil,
			},
			want:    fasten.PackageStatusQueued,
			wantErr: false,
		},
		{
			name: "unexpected response results in an error",
			args: args{
				mockClientResponse: makeSimplePackageResponse(t, http.StatusBadGateway),
				mockClientError:    nil,
			},
			want:    fasten.PackageStatusUnknown,
			wantErr: true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Given
			client, mockClient := makeMockClient(t)

			// And
			mockClient.On("Do", mock.Anything).Return(&tt.args.mockClientResponse, tt.args.mockClientError)

			// When
			got, err := fasten.GetPackageWithoutBody(
				context.Background(), client,
				"org.latencyutils", "LatencyUtils", "1.2.3",
			)

			// Then
			if tt.wantErr {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, tt.want, got)
			}
		})
	}
}

func TestGetSimpleVulnerabilities(t *testing.T) {
	t.Parallel()

	type args struct {
		mockClientResponse http.Response
		mockClientError    error
	}

	tests := []struct {
		name    string
		args    args
		want    []fastenapi.PackageVulnerability
		wantErr bool
	}{
		{
			name: "fetching package vulnerabilities works",
			args: args{
				mockClientResponse: makeSimpleVulnerabilitiesResponse(t, http.StatusOK),
				mockClientError:    nil,
			},
			want: []fastenapi.PackageVulnerability{
				{
					ExternalId: "CVE-2021-44832",
					Id:         29961,
					Statement: map[string]interface{}{
						"severity": "MODERATE",
					},
				},
			},
			wantErr: false,
		},
		{
			name: "fetching empty package vulnerabilities works",
			args: args{
				mockClientResponse: makeEmptyArrayResponse(t),
				mockClientError:    nil,
			},
			want:    []fastenapi.PackageVulnerability{},
			wantErr: false,
		},

		{
			name: "unexpected response results in an error",
			args: args{
				mockClientResponse: makeSimpleVulnerabilitiesResponse(t, http.StatusBadGateway),
				mockClientError:    nil,
			},
			want:    []fastenapi.PackageVulnerability{},
			wantErr: true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Given
			client, mockClient := makeMockClient(t)

			// And
			mockClient.On("Do", mock.Anything).Return(&tt.args.mockClientResponse, tt.args.mockClientError)

			// When
			got, err := fasten.GetSimpleVulnerabilities(
				context.Background(), client,
				"org.latencyutils", "LatencyUtils", "1.2.3",
			)

			// Then
			if tt.wantErr {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, tt.want, got)
			}
		})
	}
}

func TestGetVulnerabilityCallables(t *testing.T) {
	t.Parallel()

	type args struct {
		mockClientResponse http.Response
		mockClientError    error
	}

	tests := []struct {
		name    string
		args    args
		want    map[string]string
		wantErr bool
	}{
		{
			name: "fetching vulnerable callable identifiers works",
			args: args{
				mockClientResponse: makeVulnerableCallablesResponse(t, http.StatusOK),
				mockClientError:    nil,
			},
			want: map[string]string{
				"1266843": "fasten://mvn!dom4j:dom4j$1.6/org.dom4j.io/SAXReader.setIncludeExternalDTDDeclarations(%2Fjava.lang%2FBooleanType)%2Fjava.lang%2FVoidType",
				"1266844": "fasten://mvn!dom4j:dom4j$1.6/org.dom4j.io/SAXReader.setDispatchHandler(DispatchHandler)%2Fjava.lang%2FVoidType",
				"1266841": "fasten://mvn!dom4j:dom4j$1.6/org.dom4j.io/SAXReader.%3Cinit%3E(%2Forg.dom4j%2FDocumentFactory,%2Fjava.lang%2FBooleanType)%2Fjava.lang%2FVoidType",
			},
			wantErr: false,
		},
		{
			name: "fetching empty vulnerable callable list works",
			args: args{
				mockClientResponse: makeEmptyObjectResponse(t),
				mockClientError:    nil,
			},
			want:    map[string]string{},
			wantErr: false,
		},
		{
			name: "unexpected response results in an error",
			args: args{
				mockClientResponse: makeVulnerableCallablesResponse(t, http.StatusBadGateway),
				mockClientError:    nil,
			},
			want:    map[string]string{},
			wantErr: true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Given
			client, mockClient := makeMockClient(t)

			// And
			mockClient.On("Do", mock.Anything).Return(&tt.args.mockClientResponse, tt.args.mockClientError)

			// When
			got, err := fasten.GetVulnerabilityCallables(context.Background(), client, "CVE-2019-3797")

			// Then
			if tt.wantErr {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, tt.want, got)
			}
		})
	}
}

func TestGetCallables(t *testing.T) {
	t.Parallel()

	type args struct {
		mockClientResponse http.Response
		mockClientError    error
	}

	tests := []struct {
		name    string
		args    args
		want    map[string]fastenapi.Callable
		wantErr bool
	}{
		{
			name: "fetching vulnerable callable identifiers works",
			args: args{
				mockClientResponse: makeCallablesResponse(t, http.StatusOK),
				mockClientError:    nil,
			},
			want: map[string]fastenapi.Callable{
				"32548": {
					FastenUri:      "/org.springframework.data.jpa.domain/JpaSort$JpaOrder.isIgnoreCase()%2Fjava.lang%2FBooleanType",
					IsInternalCall: true,
					Metadata: fastenapi.CallableMetadata{
						Vulnerabilities: nil,
						Quality: &fastenapi.CallableQuality{
							CallableName: "JpaSort::JpaOrder::isIgnoreCase",
						},
					},
				},
			},
			wantErr: false,
		},
		{
			name: "fetching empty vulnerable callable list works",
			args: args{
				mockClientResponse: makeEmptyObjectResponse(t),
				mockClientError:    nil,
			},
			want:    map[string]fastenapi.Callable{},
			wantErr: false,
		},
		{
			name: "unexpected response results in an error",
			args: args{
				mockClientResponse: makeCallablesResponse(t, http.StatusBadGateway),
				mockClientError:    nil,
			},
			want:    map[string]fastenapi.Callable{},
			wantErr: true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// Given
			client, mockClient := makeMockClient(t)

			// And
			mockClient.On("Do", mock.Anything).Return(&tt.args.mockClientResponse, tt.args.mockClientError)

			// When
			got, err := fasten.GetCallables(context.Background(), client, []int{32548})

			// Then
			if tt.wantErr {
				require.Error(t, err)
			} else {
				require.NoError(t, err)
				assert.Equal(t, tt.want, got)
			}
		})
	}
}
