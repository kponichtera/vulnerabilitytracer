package fasten

import (
	"context"
	"errors"
	"fmt"
	"net/http"

	"vulnerabilitytracer-service/api/generated/fastenclient"
)

type PackageStatus int

const (
	PackageStatusProcessed PackageStatus = iota
	PackageStatusQueued    PackageStatus = iota
	PackageStatusUnknown   PackageStatus = iota
)

var ErrUnexpectedAPIResponse = errors.New("unexpected FASTEN API response")

func NewAPIClient(fastenAPIURL string) (*fastenclient.Client, error) {
	client, err := fastenclient.NewClient(fastenAPIURL)
	if err != nil {
		return nil, fmt.Errorf("error when creating FASTEN API client: %w", err)
	}

	return client, nil
}

func GetPackageWithoutBody(
	ctx context.Context, client fastenclient.ClientInterface,
	groupID string, artifactID string, version string,
) (PackageStatus, error) {
	response, err := client.GetApiMvnPackagesGroupIdArtifactIdVersion(ctx, groupID, artifactID, version)
	if err != nil {
		return PackageStatusUnknown, fmt.Errorf("error when calling FASTEN API: %w", err)
	}

	switch response.StatusCode {
	case http.StatusOK:
		return PackageStatusProcessed, nil
	case http.StatusCreated:
		return PackageStatusQueued, nil
	default:
		return PackageStatusUnknown, fmt.Errorf("unexpected status code %d: %w", response.StatusCode, ErrUnexpectedAPIResponse)
	}
}
