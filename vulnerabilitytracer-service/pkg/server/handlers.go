package server

import (
	"context"

	"vulnerabilitytracer-service/pkg/server/runtime"
	"vulnerabilitytracer-service/pkg/service"

	"github.com/sirupsen/logrus"

	"vulnerabilitytracer-service/api/generated/api"
)

type serverInterfaceImpl struct {
	runtime.Context
}

func (s serverInterfaceImpl) PostApiRegister(ctx context.Context, request api.PostApiRegisterRequestObject) (api.PostApiRegisterResponseObject, error) {
	existingServiceId, err := service.CheckServiceRegistration(ctx, s.Context, request.Body.ServiceName, request.Body.Dependencies)
	if err != nil {
		logrus.WithError(err).Error("error when registering service")
		return api.PostApiRegister500JSONResponse{Message: err.Error()}, nil
	}

	if existingServiceId == nil {
		// Service was not registered previously - register it and its dependencies
		serviceID, err := service.RegisterService(ctx, s.Context, request.Body.ServiceName, request.Body.Dependencies)
		if err != nil {
			logrus.WithError(err).Error("error when registering service")
			return api.PostApiRegister500JSONResponse{Message: err.Error()}, nil
		}

		err = service.RegisterServiceDependencies(ctx, s.Context, serviceID, request.Body.Dependencies)
		if err != nil {
			logrus.WithError(err).Error("error when registering service dependencies")
			return api.PostApiRegister500JSONResponse{Message: err.Error()}, nil
		}

		// TODO: Get callables and vulnerabilities for dependencies, and persist them

	}

	_, err = service.FetchVulnerabilitiesAndCallables(ctx, s.Context, request.Body.Dependencies)
	if err != nil {
		return nil, err
	}

	return api.PostApiRegister200JSONResponse{
		Callables: nil,
	}, nil
}

func (s serverInterfaceImpl) GetLiveness(ctx context.Context, request api.GetLivenessRequestObject) (api.GetLivenessResponseObject, error) {
	err := s.DBPool.Ping(ctx)
	if err != nil {
		return nil, err
	}

	return api.GetLiveness200Response{}, nil
}

func (s serverInterfaceImpl) GetReadiness(ctx context.Context, request api.GetReadinessRequestObject) (api.GetReadinessResponseObject, error) {
	return api.GetReadiness200Response{}, nil
}
