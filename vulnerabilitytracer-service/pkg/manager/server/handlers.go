package server

import (
	"context"
	"github.com/sirupsen/logrus"
	"vulnerabilitytracer/api/generated/managerapi"
	"vulnerabilitytracer/pkg/manager/runtime"
	"vulnerabilitytracer/pkg/manager/service"
)

type serverInterfaceImpl struct {
	runtime.Context
}

func (s serverInterfaceImpl) GetDashboardNotifications(ctx context.Context, request managerapi.GetDashboardNotificationsRequestObject) (managerapi.GetDashboardNotificationsResponseObject, error) {
	notifications, err := service.GetDashboardNotifications(ctx, s.Context)
	if err != nil {
		logrus.WithError(err).Error("error when getting dashboard notifications")
		return managerapi.GetDashboardNotifications500JSONResponse{Message: err.Error()}, nil
	}
	return managerapi.GetDashboardNotifications200JSONResponse{Notifications: notifications}, nil
}

func (s serverInterfaceImpl) DismissNotification(ctx context.Context, request managerapi.DismissNotificationRequestObject) (managerapi.DismissNotificationResponseObject, error) {
	err := service.DismissNotification(ctx, s.Context, request.Body.NotificationId)
	if err != nil {
		logrus.WithError(err).Error("error when dismissing notification")
		return managerapi.DismissNotification500JSONResponse{Message: err.Error()}, nil
	}
	return managerapi.DismissNotification200Response{}, nil
}

func (s serverInterfaceImpl) GetImpactGraph(ctx context.Context, request managerapi.GetImpactGraphRequestObject) (managerapi.GetImpactGraphResponseObject, error) {
	result, err := service.GetImpactGraph(ctx, s.Context, request.Body.VulnerabilityExternalId, request.Body.FromDateTime, request.Body.ToDateTime, request.Body.EdgeMetric)
	if err != nil {
		logrus.WithError(err).Error("error when getting impact graph")
		return managerapi.GetImpactGraph500JSONResponse{Message: err.Error()}, nil
	}
	return managerapi.GetImpactGraph200JSONResponse{
		Edges: result.Edges,
		Nodes: result.Nodes,
	}, nil
}

func (s serverInterfaceImpl) GetVulnerabilityServices(ctx context.Context, request managerapi.GetVulnerabilityServicesRequestObject,
) (managerapi.GetVulnerabilityServicesResponseObject, error) {
	result, err := service.GetVulnerabilityServices(ctx, s.Context, request.Body.VulnerabilityExternalId, request.Body.FromDateTime, request.Body.ToDateTime)
	if err != nil {
		logrus.WithError(err).Error("error when getting vulnerability services")
		return managerapi.GetVulnerabilityServices500JSONResponse{Message: err.Error()}, nil
	}
	return managerapi.GetVulnerabilityServices200JSONResponse{Services: result}, nil
}

func (s serverInterfaceImpl) GetDashboardVulnerabilities(ctx context.Context, request managerapi.GetDashboardVulnerabilitiesRequestObject,
) (managerapi.GetDashboardVulnerabilitiesResponseObject, error) {
	result, err := service.GetDashboardVulnerabilities(ctx, s.Context, request.Body.FromDateTime, request.Body.ToDateTime)
	if err != nil {
		logrus.WithError(err).Error("error when getting dashboard vulnerabilities")
		return managerapi.GetDashboardVulnerabilities500JSONResponse{Message: err.Error()}, nil
	}
	return managerapi.GetDashboardVulnerabilities200JSONResponse{Vulnerabilities: result}, nil
}

func (s serverInterfaceImpl) GetServiceMitigations(ctx context.Context, request managerapi.GetServiceMitigationsRequestObject,
) (managerapi.GetServiceMitigationsResponseObject, error) {
	result, err := service.GetServiceMitigations(ctx, s.Context, request.Body.VulnerabilityExternalId, request.Body.FromDateTime, request.Body.ToDateTime)
	if err != nil {
		logrus.WithError(err).Error("error when getting service mitigations")
		return managerapi.GetServiceMitigations500JSONResponse{Message: err.Error()}, nil
	}
	return managerapi.GetServiceMitigations200JSONResponse{Services: result}, nil
}

func (s serverInterfaceImpl) ApplyMitigationStrategy(ctx context.Context, request managerapi.ApplyMitigationStrategyRequestObject,
) (managerapi.ApplyMitigationStrategyResponseObject, error) {
	err := service.ApplyMitigationStrategy(ctx, s.Context, request.Body.ServiceId, request.Body.CallableId, request.Body.MitigationStrategy)
	if err != nil {
		logrus.WithError(err).Error("error when applying mitigation strategy")
		return managerapi.ApplyMitigationStrategy500JSONResponse{Message: err.Error()}, nil
	}
	return managerapi.ApplyMitigationStrategy200Response{}, nil
}

func (s serverInterfaceImpl) GetLiveness(ctx context.Context, request managerapi.GetLivenessRequestObject,
) (managerapi.GetLivenessResponseObject, error) {
	return managerapi.GetLiveness200Response{}, nil
}

func (s serverInterfaceImpl) GetReadiness(ctx context.Context, request managerapi.GetReadinessRequestObject,
) (managerapi.GetReadinessResponseObject, error) {
	err := s.DBPool.Ping(ctx)
	if err != nil {
		return nil, err
	}

	return managerapi.GetReadiness200Response{}, nil
}
