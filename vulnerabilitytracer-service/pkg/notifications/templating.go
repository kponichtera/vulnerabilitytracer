package notifications

import (
	"errors"
	"fmt"
	"vulnerabilitytracer/db/generated/queries"
)

const newVulnerabilityInServiceTemplate = `New vulnerability %s discovered in service %s, restart it to start counting the triggers`
const mitigationAppliedTemplate = `Service %s has to be restarted in order to apply mitigation strategies`

var (
	ErrMissingServiceName             = errors.New("service name is required for templating")
	ErrMissingVulnerabilityExternalID = errors.New("service name is required for templating")
	ErrIncorrectNotificationType      = errors.New("no template exists for the notification type")
)

func TemplateDashboardNotification(notificationType queries.NotificationsNotificationType,
	serviceName *string, vulnerabilityExternalID *string,
) (string, error) {
	switch notificationType {
	case queries.NotificationsNotificationTypeNEWVULNERABILITYINSERVICE:
		if serviceName == nil {
			return "", ErrMissingServiceName
		}

		if vulnerabilityExternalID == nil {
			return "", ErrMissingVulnerabilityExternalID
		}

		return fmt.Sprintf(newVulnerabilityInServiceTemplate, *vulnerabilityExternalID, *serviceName), nil
	case queries.NotificationsNotificationTypeMITIGATIONAPPLIED:
		if serviceName == nil {
			return "", ErrMissingServiceName
		}

		return fmt.Sprintf(mitigationAppliedTemplate, *serviceName), nil
	default:
		panic(ErrIncorrectNotificationType)
	}
}
