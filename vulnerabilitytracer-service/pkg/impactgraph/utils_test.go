package impactgraph_test

import (
	"github.com/google/uuid"
	"github.com/stretchr/testify/require"
	"testing"
	"vulnerabilitytracer/pkg/impactgraph"
)

func TestFindingImpactGraphRoot(t *testing.T) {
	t.Parallel()

	correctGraph, correctRoot := buildCorrectImpactGraph()
	cyclicGraph, _ := buildCyclicImpactGraph()

	tests := []struct {
		name             string
		graph            impactgraph.Graph
		expectedRootUUID uuid.UUID
		expectedError    error
	}{
		{
			name:             "finding root in correct impact graph works",
			graph:            correctGraph,
			expectedRootUUID: correctRoot,
			expectedError:    nil,
		},
		{
			name:             "finding root in cyclic impact graph returns error",
			graph:            cyclicGraph,
			expectedRootUUID: uuid.Nil,
			expectedError:    impactgraph.ErrGraphNotRooted,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// When
			root, err := impactgraph.FindRoot(tt.graph)

			// Then
			if tt.expectedError != nil {
				require.Error(t, tt.expectedError)
			} else {
				require.NoError(t, err)
				require.Equal(t, tt.expectedRootUUID, *root)
			}
		})
	}

}

func buildCorrectImpactGraph() (impactgraph.Graph, uuid.UUID) {
	rootUUID := uuid.New()
	node2UUID := uuid.New()
	node3UUID := uuid.New()

	resultGraph := impactgraph.NewGraph()
	_ = resultGraph.AddVertex(impactgraph.Node{
		TempoID:     "tempo-id-1",
		ServiceName: "service-1",
		UUID:        rootUUID,
	})
	_ = resultGraph.AddVertex(impactgraph.Node{
		TempoID:     "tempo-id-2",
		ServiceName: "service-2",
		UUID:        node2UUID,
	})
	_ = resultGraph.AddVertex(impactgraph.Node{
		TempoID:     "tempo-id-3",
		ServiceName: "service-3",
		UUID:        node3UUID,
	})
	_ = resultGraph.AddEdge(rootUUID, node2UUID)
	_ = resultGraph.AddEdge(node2UUID, node3UUID)
	return resultGraph, rootUUID
}

func buildCyclicImpactGraph() (impactgraph.Graph, uuid.UUID) {
	rootUUID := uuid.New()
	node2UUID := uuid.New()
	node3UUID := uuid.New()

	resultGraph := impactgraph.NewGraph()
	_ = resultGraph.AddVertex(impactgraph.Node{
		TempoID:     "tempo-id-1",
		ServiceName: "service-1",
		UUID:        rootUUID,
	})
	_ = resultGraph.AddVertex(impactgraph.Node{
		TempoID:     "tempo-id-2",
		ServiceName: "service-2",
		UUID:        node2UUID,
	})
	_ = resultGraph.AddVertex(impactgraph.Node{
		TempoID:     "tempo-id-3",
		ServiceName: "service-3",
		UUID:        node3UUID,
	})
	_ = resultGraph.AddEdge(rootUUID, node2UUID)
	_ = resultGraph.AddEdge(node2UUID, node3UUID)
	_ = resultGraph.AddEdge(node3UUID, rootUUID)
	return resultGraph, rootUUID
}
