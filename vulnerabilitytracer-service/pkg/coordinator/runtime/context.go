package runtime

import (
	"vulnerabilitytracer/db/generated/queries"
	"vulnerabilitytracer/pkg/coordinator/callables"
	"vulnerabilitytracer/pkg/coordinator/fasten"
	"vulnerabilitytracer/pkg/db"
	"vulnerabilitytracer/pkg/utils"

	"github.com/sirupsen/logrus"

	"github.com/jackc/pgx/v5/pgxpool"
)

type Context struct {
	DBPool                   *pgxpool.Pool
	DBQueries                *queries.Queries
	FastenCallableRepository callables.JavaCallableRepository
}

func (c *Context) Close() {
	c.DBPool.Close()
	logrus.Info("runtime context shutdown complete")
}

func Build(fastenConfig fasten.Config, databaseConfig db.Config) (*Context, error) {
	// FASTEN callable repository
	fastenAPIClient, err := fasten.NewAPIClient(fastenConfig.APIURL)
	if err != nil {
		return nil, err
	}

	fastenCallableRepository := callables.NewFastenJavaCallableRepository(fastenAPIClient)

	// Database
	databaseURL := utils.BuildDatabaseURL(databaseConfig)
	dbPool, err := db.NewConnectionPool(databaseURL)
	if err != nil {
		return nil, err
	}

	dbQueries := queries.New(dbPool)

	return &Context{
		DBPool:                   dbPool,
		DBQueries:                dbQueries,
		FastenCallableRepository: fastenCallableRepository,
	}, nil
}
