FROM docker.io/library/golang:1.21 AS builder-base

COPY vulnerabilitytracer-service/docker/builder/install_go_tools.sh /tmp/install_go_tools.sh
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    /tmp/install_go_tools.sh

WORKDIR /builder/api
COPY api/ ./

WORKDIR /builder/vulnerabilitytracer-service
COPY vulnerabilitytracer-service/ ./

FROM builder-base AS coordinator-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task coordinator:build

FROM builder-base AS manager-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task manager:build

FROM builder-base AS tracescraper-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task tracescraper:build

FROM builder-base AS eventscraper-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task eventscraper:build

FROM alpine:3.18 AS runtime-base

RUN adduser -S app
RUN apk add --no-cache dumb-init

FROM runtime-base AS coordinator-runtime
EXPOSE 10420

COPY --from=coordinator-builder /builder/vulnerabilitytracer-service/out/bin/coordinator /coordinator
USER app

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/coordinator"]
CMD ["--prefork"]

FROM runtime-base AS manager-runtime
EXPOSE 11420

COPY --from=manager-builder /builder/vulnerabilitytracer-service/out/bin/manager /manager
USER app

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/manager"]
CMD ["--prefork"]

FROM runtime-base AS tracescraper-runtime

COPY --from=tracescraper-builder /builder/vulnerabilitytracer-service/out/bin/tracescraper /tracescraper
USER app

ENTRYPOINT ["/tracescraper"]

FROM runtime-base AS eventscraper-runtime

COPY --from=eventscraper-builder /builder/vulnerabilitytracer-service/out/bin/eventscraper /eventscraper
USER app

ENTRYPOINT ["/eventscraper"]
