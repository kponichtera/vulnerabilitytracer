FROM docker.io/library/golang:1.21 AS builder-base

COPY vulnerabilitytracer-service/docker/builder/install_go_tools.sh /tmp/install_go_tools.sh
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    /tmp/install_go_tools.sh

WORKDIR /builder/api
COPY api/ ./

WORKDIR /builder/vulnerabilitytracer-service
COPY vulnerabilitytracer-service/ ./

FROM builder-base AS coordinator-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task coordinator:build

FROM builder-base AS manager-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task manager:build

FROM builder-base AS tracecollector-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task tracecollector:build

FROM builder-base AS traceprocessor-builder

RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    --mount=type=cache,target=/go/src \
    task traceprocessor:build

FROM alpine:3.18 AS runtime-base

RUN adduser -S app
RUN apk add --no-cache dumb-init

FROM runtime-base AS coordinator-runtime
EXPOSE 10420

COPY --from=coordinator-builder /builder/vulnerabilitytracer-service/out/bin/coordinator /coordinator
USER app

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/coordinator"]
CMD ["--prefork"]

FROM runtime-base AS manager-runtime
EXPOSE 11420

COPY --from=manager-builder /builder/vulnerabilitytracer-service/out/bin/manager /manager
USER app

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/manager"]
CMD ["--prefork"]

FROM runtime-base AS tracecollector-runtime

COPY --from=tracecollector-builder /builder/vulnerabilitytracer-service/out/bin/tracecollector /tracecollector
USER app

ENTRYPOINT ["/tracecollector"]

FROM runtime-base AS traceprocessor-runtime

COPY --from=traceprocessor-builder /builder/vulnerabilitytracer-service/out/bin/traceprocessor /traceprocessor
USER app

ENTRYPOINT ["/traceprocessor"]
