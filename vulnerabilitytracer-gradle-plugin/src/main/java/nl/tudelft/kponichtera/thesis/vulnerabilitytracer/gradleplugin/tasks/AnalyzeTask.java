package nl.tudelft.kponichtera.thesis.vulnerabilitytracer.gradleplugin.tasks;

import nl.tudelft.kponichtera.thesis.vulnerabilitytracer.gradleplugin.report.DependencyCheckReport;
import nl.tudelft.kponichtera.thesis.vulnerabilitytracer.gradleplugin.utils.ReportLoaderUtils;
import nl.tudelft.kponichtera.thesis.vulnerabilitytracer.gradleplugin.utils.ReportParserUtils;
import org.gradle.api.DefaultTask;
import org.gradle.api.GradleException;
import org.gradle.api.tasks.TaskAction;

import java.io.IOException;
import java.util.Optional;

public class AnalyzeTask extends DefaultTask {

    public AnalyzeTask() {
        setGroup("vulnerability-tracer");
        setDescription("Analyzes OWASP DependencyCheck report and extracts the packages of vulnerable libraries, for use with the instrumentation agent");
    }

    @TaskAction
    public void analyzeReport() {
        var report = loadReport();
        ReportParserUtils.readDependencies(getProject(), report);
    }

    private DependencyCheckReport loadReport() throws GradleException {
        Optional<DependencyCheckReport> report;
        try {
            report = ReportLoaderUtils.loadReport(getProject());
        } catch (IOException e) {
            throw new GradleException("Error when loading the report", e);
        }

        if (report.isEmpty()) {
            throw new GradleException("DependencyCheck JSON report is not present. Make sure that DependencyCheck plugin is configured to generate JSON reports.");
        }
        return report.get();
    }

}
