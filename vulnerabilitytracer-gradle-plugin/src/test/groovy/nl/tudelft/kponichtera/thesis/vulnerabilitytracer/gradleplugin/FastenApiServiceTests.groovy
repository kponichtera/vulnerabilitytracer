package nl.tudelft.kponichtera.thesis.vulnerabilitytracer.gradleplugin

import nl.tudelft.kponichtera.thesis.vulnerabilitytracer.gradleplugin.service.FastenApiService
import org.mockserver.integration.ClientAndServer
import org.mockserver.model.HttpRequest
import org.mockserver.model.HttpResponse
import org.mockserver.model.NottableString
import spock.lang.Shared
import spock.lang.Specification

class FastenApiServiceTests extends Specification {

    @Shared
    private mockServerClient = ClientAndServer.startClientAndServer()

    def cleanupSpec() {
        mockServerClient.stop()
    }

    def "making package request with discarding body works"() {
        given:
        mockPackageResponse()
        def port = mockServerClient.port
        def service = new FastenApiService("http://localhost:$port", 1)

        and:
        def groupName = "org.latencyutils"
        def artifactName = "LatencyUtils"

        when:
        def response = service.getPackageWithoutBody(groupName, artifactName, packageVersion).get()

        then:
        response.statusCode() == expectedResponseStatusCode

        cleanup:
        mockServerClient.reset()

        where:
        packageVersion | expectedResponseStatusCode
        "2.0.3"        | 200
        "2.0.4"        | 201
    }

    def "making vulnerability request works"() {
        given:
        mockVulnerabilitiesResponse()
        def port = mockServerClient.port
        def service = new FastenApiService("http://localhost:$port", 1)

        and:
        def groupName = "org.latencyutils"
        def artifactName = "LatencyUtils"
        def packageVersion = "2.0.3"

        when:
        def vulnerabilities = service.getVulnerabilities(groupName, artifactName, packageVersion).get()

        then:
        !vulnerabilities.empty
        vulnerabilities[0].externalId() != null

        cleanup:
        mockServerClient.reset()
    }

    def "making vulnerability callables request works when there exist callables"() {
        given:
        mockVulnerabilityCallablesResponse()
        def port = mockServerClient.port
        def service = new FastenApiService("http://localhost:$port", 1)

        and:
        def vulnerabilityId = "CVE-2019-3797"

        when:
        def callables = service.getVulnerabilityCallables(vulnerabilityId).get()

        then:
        !callables.isEmpty()
        callables[1266843L] != null

        cleanup:
        mockServerClient.reset()
    }

    def "making vulnerability callables request works when there are no callables"() {
        given:
        mockNoVulnerabilityCallablesResponse()
        def port = mockServerClient.port
        def service = new FastenApiService("http://localhost:$port", 1)

        and:
        def vulnerabilityId = "CVE-2019-3797"

        when:
        def callables = service.getVulnerabilityCallables(vulnerabilityId).get()

        then:
        callables.isEmpty()

        cleanup:
        mockServerClient.reset()
    }

    def "making callables request works"() {
        given:
        mockCallablesResponse()
        def port = mockServerClient.port
        def service = new FastenApiService("http://localhost:$port", 1)

        when:
        def callables = service.getCallables(callableIds).get()

        then:
        !callables.isEmpty()
        callables[32548L].fastenUri() != null
        callables[32548L].metadata().quality().callableName() != null

        cleanup:
        mockServerClient.reset()

        where:
        callableIds              | _
        [32548L]                 | _
        [32548L, 23456L, 34567L] | _
    }

    private mockPackageResponse() {
        mockServerClient.when(
                HttpRequest.request()
                        .withMethod("GET")
                        .withPath("/api/mvn/packages/org.latencyutils:LatencyUtils/2.0.3")
        ).respond(
                HttpResponse.response()
                        .withStatusCode(200)
                        .withBody("""
                            [{
                                  "id": 17,
                                  "package_id": 25,
                                  "version": "2.17.0",
                                  "cg_generator": "OPAL",
                                  "repository_base_url": "https://repo.maven.apache.org/maven2/",
                                  "metadata": {}
                            }]
                        """)
        )

        mockServerClient.when(
                HttpRequest.request()
                        .withMethod("GET")
                        .withPath(NottableString.not("/api/mvn/packages/org.latencyutils:LatencyUtils/2.0.3"))
        ).respond(
                HttpResponse.response()
                        .withStatusCode(201)
                        .withBody("Package version not found, but should be processed soon. Try again later.")
        )
    }

    private mockVulnerabilitiesResponse() {
        mockServerClient.when(
                HttpRequest.request()
                        .withMethod("GET")
                        .withPath("/api/mvn/packages/org.latencyutils:LatencyUtils/2.0.3/vulnerabilities")
        ).respond(
                HttpResponse.response()
                        .withStatusCode(200)
                        .withBody("""
                            [{
                                "id": 12345,
                                "external_id": "CVE-2019-3797"
                            }]
                        """)
        )
    }

    private mockVulnerabilityCallablesResponse() {
        mockServerClient.when(
                HttpRequest.request()
                        .withMethod("GET")
                        .withPath("/api/mvn/vulnerabilities/CVE-2019-3797/callables")
        ).respond(
                HttpResponse.response()
                        .withStatusCode(200)
                        .withBody("""
                            {
                              "1266843": "fasten://mvn!dom4j:dom4j\$1.6/org.dom4j.io/SAXReader.setIncludeExternalDTDDeclarations(%2Fjava.lang%2FBooleanType)%2Fjava.lang%2FVoidType",
                              "1266844": "fasten://mvn!dom4j:dom4j\$1.6/org.dom4j.io/SAXReader.setDispatchHandler(DispatchHandler)%2Fjava.lang%2FVoidType",
                              "1266841": "fasten://mvn!dom4j:dom4j\$1.6/org.dom4j.io/SAXReader.%3Cinit%3E(%2Forg.dom4j%2FDocumentFactory,%2Fjava.lang%2FBooleanType)%2Fjava.lang%2FVoidType"
                            }
                        """)
        )
    }

    private mockNoVulnerabilityCallablesResponse() {
        mockServerClient.when(
                HttpRequest.request()
                        .withMethod("GET")
                        .withPath("/api/mvn/vulnerabilities/CVE-2019-3797/callables")
        ).respond(
                HttpResponse.response()
                        .withStatusCode(200)
                        .withBody("{}")
        )
    }

    private mockCallablesResponse() {
        mockServerClient.when(
                HttpRequest.request()
                        .withMethod("POST")
                        .withPath("/api/mvn/callables")
        ).respond(
                HttpResponse.response()
                        .withStatusCode(200)
                        .withBody("""
                            {
                                "32548": {
                                    "is_internal_call": true,
                                    "metadata": {
                                        "quality": {
                                            "quality_analysis_timestamp": "1676462882.74734",
                                            "callable_long_name": "JpaSort::JpaOrder::isIgnoreCase()",
                                            "quality_analyzer_version": "1.17.10",
                                            "callable_parameters": [],
                                            "rapid_plugin_version": "1.3.0",
                                            "metrics": {
                                                "nloc": 3,
                                                "complexity": 2,
                                                "token_count": 14,
                                                "parameter_count": 0,
                                                "length": 3
                                            },
                                            "quality_analyzer_name": "Lizard",
                                            "rapid_metadata_plugin_version": "1.2.2",
                                            "callable_name": "JpaSort::JpaOrder::isIgnoreCase"
                                      }
                                  },
                                  "module_id": 4576,
                                  "line_start": 411,
                                  "fasten_uri": "/org.springframework.data.jpa.domain/JpaSort\$JpaOrder.isIgnoreCase()%2Fjava.lang%2FBooleanType",
                                  "line_end": 411
                                }
                            }
                        """)
        )
    }

}
