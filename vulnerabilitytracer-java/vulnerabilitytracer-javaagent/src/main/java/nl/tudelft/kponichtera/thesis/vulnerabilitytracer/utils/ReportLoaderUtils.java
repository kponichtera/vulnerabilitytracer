package nl.tudelft.kponichtera.thesis.vulnerabilitytracer.utils;

import lombok.experimental.UtilityClass;
import nl.tudelft.kponichtera.thesis.vulnerabilitytracer.report.DependencyReport;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.Optional;

/*
 * TODO: Refactor to read the file, generated by the Gradle plugin.
 */
@UtilityClass
public class ReportLoaderUtils {

    // TODO: Move to the common config class
    private static final String REPORT_PATH_ENV_VARIABLE = "VULNERABILITYTRACER_REPORT_PATH";
    private static final String REPORT_DEFAULT_NAME = "vulnerabilitytracer-dependencies.json";

    public static Optional<DependencyReport> loadReport() throws IOException {
        var reportPath = System.getenv(REPORT_PATH_ENV_VARIABLE);
        if (reportPath == null) {
            reportPath = REPORT_DEFAULT_NAME;
        }

        // Try to load report from provided (or default) path
        var reportFile = new File(reportPath);
        if (reportFile.exists()) {
            return Optional.of(loadReport(reportFile));
        }

        // No report file found anywhere
        return Optional.empty();
    }

    public static DependencyReport loadReport(File reportFile) throws IOException {
        return ReportMapperUtils.getMapper().readValue(reportFile, DependencyReport.class);
    }

    public static DependencyReport loadReport(InputStream reportInputStream) throws IOException {
        return ReportMapperUtils.getMapper().readValue(reportInputStream, DependencyReport.class);
    }

}
