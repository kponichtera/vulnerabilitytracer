package nl.tudelft.kponichtera.thesis.vulnerabilitytracer.instrumentation;

import io.opentelemetry.context.Context;
import io.opentelemetry.context.Scope;
import net.bytebuddy.asm.Advice;
import nl.tudelft.kponichtera.thesis.vulnerabilitytracer.helper.VulnerabilityHolderHelper;
import nl.tudelft.kponichtera.thesis.vulnerabilitytracer.utils.ReportUtils;

import java.io.IOException;

/**
 * Rules to follow when writing advices:
 * https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/contributing/writing-instrumentation-module.md#use-advice-classes-to-write-code-that-will-get-injected-to-the-instrumented-library-classes
 */
@SuppressWarnings("unused")
public final class VulnerabilityTracerAdvice {

    @Advice.OnMethodEnter
    public static void onEnter(@Advice.Origin("#m") String methodName,
                               @Advice.Origin("#t") String typeName,
                               @Advice.Local("otelContext") Context context,
                               @Advice.Local("otelScope") Scope scope
    ) throws IOException {
        System.out.printf("Method entered: %s.%s%n", typeName, methodName);

        System.out.println("initializing static holder");
        var vulnerabilityHolder = VulnerabilityHolderHelper.initializeStaticHolder();

        System.out.println("extracing fasten method name");
        var fastenMethodName = ReportUtils.fromOpentelemetryToFastenMethodName(typeName, methodName);
        // TODO: Add the vulnerability to the span
    }


}
